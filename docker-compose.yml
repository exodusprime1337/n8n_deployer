include:
  - ./supabase/docker/docker-compose.yml

services:
  n8n: 
    image: n8nio/n8n:2.2.4
    restart: unless-stopped
    container_name: n8n
    environment:
      # DB Settings
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: n8n_db
      DB_POSTGRESDB_USER: ${N8N_POSTGRES_NON_ROOT_USER}
      DB_POSTGRESDB_PASSWORD: ${N8N_POSTGRES_NON_ROOT_PASSWORD}
      DB_POSTGRESDB_DATABASE: ${N8N_POSTGRES_DB}
      # N8N Settings
      NODE_ENV: production
      N8N_PROXY_HOPS: 1
      N8N_DIAGNOSTICS_ENABLED: true
      N8N_PERSONALIZATION_ENABLED: false
      N8N_HIRING_BANNER_ENABLED: false
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      WEBHOOK_URL: ${WEBHOOK_URL}
      N8N_EDITOR_BASE_URL: ${N8N_EDITOR_BASE_URL}
      N8N_PROTOCOL: "https"
      # N8N Runners Settings
      N8N_RUNNERS_ENABLED: true
      N8N_RUNNERS_BROKER_LISTEN_ADDRESS: 0.0.0.0
      N8N_HEALTH_CHECK_SERVER_PORT: 5679
      N8N_RUNNERS_MODE: external
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN}
      N8N_NATIVE_PYTHON_RUNNER: true
      N8N_METRICS: true
      OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS: true
      QUEUE_HEALTH_CHECK_ACTIVE: true
      EXECUTIONS_DATA_SAVE_ON_ERROR: all
      EXECUTIONS_DATA_SAVE_ON_SUCCESS: none
      EXECUTIONS_DATA_SAVE_ON_PROGRESS: true
      EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS: false
      EXECUTIONS_DATA_PRUNE: true
      EXECUTIONS_DATA_MAX_AGE: 168
      EXECUTIONS_DATA_PRUNE_MAX_COUNT: 50000
      # Queue mode settings
      EXECUTIONS_MODE: queue
      QUEUE_BULL_REDIS_HOST: redis
      QUEUE_BULL_REDIS_PORT: 6379
    expose:
      - 5678/tcp
    volumes:
      - n8n_storage:/home/node/.n8n
    depends_on:
      n8n_db:
        condition: service_healthy

  n8n-worker:
    image: n8nio/n8n:2.2.4
    container_name: n8n-worker
    restart: unless-stopped
    command: worker
    volumes:
      - n8n_worker_storage:/home/node/.n8n
    environment:
      # --- Database (Postgres) ---
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: n8n_db
      DB_POSTGRESDB_USER: ${N8N_POSTGRES_NON_ROOT_USER}
      DB_POSTGRESDB_PASSWORD: ${N8N_POSTGRES_NON_ROOT_PASSWORD}
      DB_POSTGRESDB_DATABASE: ${N8N_POSTGRES_DB}

      # --- Queue mode (Redis/Bull) ---
      EXECUTIONS_MODE: queue
      QUEUE_BULL_REDIS_HOST: redis
      QUEUE_BULL_REDIS_PORT: 6379

      # Worker concurrency (start conservative; raise as CPU allows)
      N8N_WORKER_CONCURRENCY: 5

      # Must match the main container if using encryption
      # N8N Settings
      NODE_ENV: production
      WEBHOOK_URL: ${WEBHOOK_URL}
      N8N_DIAGNOSTICS_ENABLED: false
      N8N_PERSONALIZATION_ENABLED: false
      N8N_RUNNERS_BROKER_LISTEN_ADDRESS: 0.0.0.0
      N8N_HEALTH_CHECK_SERVER_PORT: 5679
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      N8N_LOG_LEVEL: info
      # N8N Runners Settings
      N8N_RUNNERS_ENABLED: true
      N8N_RUNNERS_MODE: external
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN}
      N8N_NATIVE_PYTHON_RUNNER: true
    depends_on:
      n8n_db:
        condition: service_healthy
      redis:
        condition: service_healthy

  n8n-task-runner:
    image: n8nio/runners:stable
    environment:
      N8N_RUNNERS_TASK_BROKER_URI: http://n8n:5679
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN}
    volumes:
      - ./n8n_extras/n8n-task-runners.json:/etc/n8n-task-runners.json
    depends_on:
      - n8n

  n8n-worker-task-runner:
    image: n8nio/runners:stable
    environment:
      N8N_RUNNERS_TASK_BROKER_URI: http://n8n-worker:5679
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN}
    volumes:
      - ./n8n_extras/n8n-task-runners.json:/etc/n8n-task-runners.json
    depends_on:
      - n8n-worker

  n8n_db:
    image: postgres:16
    container_name: n8n_db
    restart: always
    environment:
      POSTGRES_USER: ${N8N_POSTGRES_USER}
      POSTGRES_PASSWORD: ${N8N_POSTGRES_PASSWORD}
      POSTGRES_DB: ${N8N_POSTGRES_DB}
      POSTGRES_NON_ROOT_USER: ${N8N_POSTGRES_NON_ROOT_USER}
      POSTGRES_NON_ROOT_PASSWORD: ${N8N_POSTGRES_NON_ROOT_PASSWORD}
    volumes:
      - db_storage:/var/lib/postgresql/data
      - ./init-data.sh:/docker-entrypoint-initdb.d/init-data.sh
    expose:
      - 5432/tcp
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -h localhost -U ${N8N_POSTGRES_NON_ROOT_USER} -d ${N8N_POSTGRES_DB}",
        ]
      interval: 5s
      timeout: 5s
      retries: 10
  redis:
    image: redis:7.4-alpine
    container_name: redis
    restart: always
    command: redis-server --save 20 1 --loglevel warning 
    expose:
      - 6379/tcp
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 10

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    environment:
      QDRANT__SERVICE__API_KEY: ${QDRANT__SERVICE__API_KEY}
    restart: unless-stopped
    expose:
      - 6333/tcp
    volumes:
      - qdrant_storage:/qdrant/storage

  nginx:
    container_name: nginx
    image: nginx:alpine
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    depends_on:
      n8n:
        condition: service_started
        
volumes:
  db_storage:
  n8n_storage:
  qdrant_storage:
  postgres_data:
  redis_data:
  n8n_worker_storage:
